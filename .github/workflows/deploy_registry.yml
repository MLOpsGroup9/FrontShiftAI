name: CD – Push Model to Registry

on:
  workflow_run:
    workflows: ["CI – Train and Validate Model"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install -r requirements.txt

      - name: Push to Model Registry
        run: |
          python - <<'PYCODE'
from ml_pipeline.tracking.push_to_registry import push_to_registry
import json, pathlib

summary = json.load(open("ml_pipeline/evaluation/eval_results/unified_summary.json"))
metrics = {
    "mean_semantic_sim": summary["rag"]["mean_semantic_sim"],
    "mean_precision_at_k": summary["rag"]["mean_precision_at_k"]
}
push_to_registry("llama_3b_instruct", "Llama-3.2-3B-Instruct-Q4_K_S.gguf", metrics)
print("✅ Model successfully pushed to registry.")
PYCODE
