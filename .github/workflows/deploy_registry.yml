name: CD - Push Model to Registry

on:
  workflow_run:
    workflows: ["CI - Train and Validate Model"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Push to Model Registry
        run: |
          python -c "
          import json
          import pathlib
          from ml_pipeline.tracking.push_to_registry import push_to_registry
          
          # Load metrics from the unified summary file
          summary_path = pathlib.Path('ml_pipeline/evaluation/eval_results/unified_summary.json')
          if not summary_path.exists():
              raise FileNotFoundError(f'Missing unified summary at: {summary_path}')
          
          summary = json.load(open(summary_path))
          
          metrics = {
              'mean_semantic_sim': summary['rag']['mean_semantic_sim'],
              'mean_precision_at_k': summary['rag']['mean_precision_at_k']
          }
          
          push_to_registry(
              model_name='llama_3b_instruct',
              model_file='Llama-3.2-3B-Instruct-Q4_K_S.gguf',
              metrics=metrics
          )
          
          print('âœ… Model successfully pushed to registry.')
          "