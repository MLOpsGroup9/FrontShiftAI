name: Chat Pipeline - Core Evaluation

on:
  workflow_dispatch:

jobs:
  core-eval:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r chat_pipeline/requirements.txt
          pip install pyyaml

      - name: Set Environment Variables
        run: |
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
          echo "TOKENIZERS_PARALLELISM=false" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "INCEPTION_API_KEY=${{ secrets.INCEPTION_API_KEY }}" >> $GITHUB_ENV
          echo "CHAT_PIPELINE_REMOTE_REQUEST_DELAY=20" >> $GITHUB_ENV
          echo "CHAT_PIPELINE_REMOTE_MAX_ATTEMPTS=5" >> $GITHUB_ENV
        shell: bash

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK (gsutil)
        uses: google-github-actions/setup-gcloud@v2

      - name: Sync vector DB from GCS
        run: |
          mkdir -p chat_pipeline/data_pipeline/data/vector_db
          gsutil -m rsync -r gs://frontshiftai-data/data/vector_db/ chat_pipeline/data_pipeline/data/vector_db
          echo "CHROMA_DIR=chat_pipeline/data_pipeline/data/vector_db" >> $GITHUB_ENV
        shell: bash

      - name: Set W&B Environment Variables
        run: |
          echo "WANDB_API_KEY=${{ secrets.WANDB_API_KEY }}" >> $GITHUB_ENV
          echo "WANDB_ENTITY=group9mlops-northeastern-university" >> $GITHUB_ENV
          echo "WANDB_PROJECT=FrontShiftAI" >> $GITHUB_ENV
        shell: bash

      - name: Run Core Evaluation
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          WANDB_ENTITY: group9mlops-northeastern-university
          WANDB_PROJECT: FrontShiftAI
        run: |
          python -m chat_pipeline.cli --config chat_pipeline/configs/experiments/core_eval.yaml

      - name: Verify Core Evaluation Results
        run: |
          if [ ! -f "chat_pipeline/results/core_experiment_summary.json" ]; then
            echo "❌ chat_pipeline/results/core_experiment_summary.json not found"
            exit 1
          fi
          if [ ! -f "chat_pipeline/results/core_eval_main/summary.json" ]; then
            echo "❌ chat_pipeline/results/core_eval_main/summary.json not found"
            exit 1
          fi
          echo "✅ Core evaluation results generated successfully"

      - name: Upload Core Evaluation Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-eval-results
          path: |
            chat_pipeline/results/
            models/
          retention-days: 30

      - name: Output Metrics
        id: metrics
        run: |
          python3 << 'EOF'
          import json
          from pathlib import Path

          summary_path = Path("chat_pipeline/results/core_eval_main/summary.json")
          if summary_path.exists():
              data = json.loads(summary_path.read_text(encoding="utf-8"))
              precision = data.get("precision", "na")
              recall = data.get("recall", "na")
              groundedness = data.get("groundedness", "na")
          else:
              precision = recall = groundedness = "na"

          print(f"precision={precision}")
          print(f"recall={recall}")
          print(f"groundedness={groundedness}")
          EOF
        continue-on-error: true

      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_SENDER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          to: ${{ secrets.EMAIL_RECEIVER }}
          from: ${{ secrets.EMAIL_SENDER }}
          subject: "Core Eval ${{ job.status }} - ${{ github.workflow }}"
          body: |
            Repository: ${{ github.repository }}
            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_id }}
            Status: ${{ job.status }}
