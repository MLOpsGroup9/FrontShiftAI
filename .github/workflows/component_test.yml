# Component tests for fast feedback
# Currently configured to run on main branch only
# Can be triggered manually via workflow_dispatch for testing

name: Component Test - Fast Feedback for Feature Branches

on:
  push:
    branches: [ main, raghav-branch ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Prevent parallel runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('chat_pipeline/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'
          cache-dependency-path: chat_pipeline/requirements.txt

      - name: Install Dependencies
        run: |
          python -m pip install pip
          pip install -r chat_pipeline/requirements.txt
          pip install pytest pytest-cov

      - name: Set Environment Variables
        run: |
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
        shell: bash

      - name: Run Unit Tests
        run: |
          # Run tests if they exist
          if [ -d "chat_pipeline/tests" ] && [ "$(find chat_pipeline/tests -name 'test_*.py' | wc -l)" -gt 0 ]; then
            pytest chat_pipeline/tests/ -v --tb=short || echo "Tests failed"
          else
            echo "⚠️ No unit tests found under chat_pipeline/tests/"
          fi
        continue-on-error: false

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('chat_pipeline/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'
          cache-dependency-path: chat_pipeline/requirements.txt

      - name: Install Code Quality Tools
        run: |
          python -m pip install pip
          pip install black flake8

      - name: Check Code Formatting with Black
        run: |
          # Check formatting without modifying files
          black --check chat_pipeline/ --exclude=".*" || echo "⚠️ Code formatting issues found (non-blocking)"
        continue-on-error: false

      - name: Run Flake8 Linting
        run: |
          # Run flake8 with basic configuration
          flake8 chat_pipeline/ --max-line-length=120 --exclude=".*,__pycache__" --count --statistics || echo "⚠️ Linting issues found (non-blocking)"
        continue-on-error: false

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, code-quality]
    if: always()

    steps:
      - name: Print Summary
        run: |
          echo "## Component Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These are fast feedback tests for feature branches." >> $GITHUB_STEP_SUMMARY
          echo "Full pipeline runs on merge to main." >> $GITHUB_STEP_SUMMARY
