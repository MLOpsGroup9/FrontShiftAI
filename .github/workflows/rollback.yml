# Manual rollback workflow
# Requires manual trigger and approval for production rollbacks
# Use when you need to revert to a previous model version

name: Model Rollback - Manual Rollback Workflow

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Logical model name to rollback (default frontshift-rag)'
        required: false
        type: string
        default: 'frontshift-rag'
      target_version:
        description: 'Target version to rollback to (e.g., v5). Leave empty for previous version.'
        required: false
        type: string
      reason:
        description: 'Reason for rollback (required for audit)'
        required: true
        type: string
      use_previous:
        description: 'Rollback to previous version'
        required: false
        type: boolean
        default: false

jobs:
  validate-rollback-target:
    name: Validate Rollback Target
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      target_version: ${{ steps.resolve_version.outputs.target_version }}
      groundedness: ${{ steps.metadata.outputs.groundedness }}
      answer_relevance: ${{ steps.metadata.outputs.answer_relevance }}
      factual_correctness: ${{ steps.metadata.outputs.factual_correctness }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set Environment Variables
        run: |
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
        shell: bash

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK (gsutil)
        uses: google-github-actions/setup-gcloud@v2

      - name: List Available Versions
        run: |
          python -m chat_pipeline.tracking.rollback_model \
            --model-name "${{ inputs.model_name }}" \
            --list-versions

      - name: Resolve Target Version
        id: resolve_version
        env:
          TARGET_VERSION_INPUT: ${{ inputs.target_version }}
          USE_PREVIOUS: ${{ inputs.use_previous }}
          MODEL_NAME: ${{ inputs.model_name }}
        run: |
          if [ "$USE_PREVIOUS" = "true" ] && [ -n "$TARGET_VERSION_INPUT" ]; then
            echo "❌ Cannot set target_version when use_previous is true."
            exit 1
          fi
          ARGS=()
          if [ -n "$TARGET_VERSION_INPUT" ]; then
            ARGS+=(--target-version "$TARGET_VERSION_INPUT")
          fi
          if [ "$USE_PREVIOUS" = "true" ]; then
            ARGS+=(--previous)
          fi
          if [ ${#ARGS[@]} -eq 0 ]; then
            echo "❌ Must specify target_version or enable use_previous."
            exit 1
          fi
          TARGET=$(python -m chat_pipeline.tracking.rollback_model \
            --model-name "$MODEL_NAME" \
            --registry-dir "gs://frontshiftai-model-registry" \
            --resolve-target "${ARGS[@]}")
          if [ -z "$TARGET" ] || [ "$TARGET" = "none" ]; then
            echo "❌ Unable to resolve target version."
            exit 1
          fi
          echo "Resolved rollback target: $TARGET"
          echo "target_version=$TARGET" >> $GITHUB_OUTPUT

      - name: Load Target Metadata
        id: metadata
        env:
          TARGET_VERSION: ${{ steps.resolve_version.outputs.target_version }}
          MODEL_NAME: ${{ inputs.model_name }}
        run: |
          # We need to list-versions to populate the cache or fetch the specific version
          # However, metadata.json is small, so we can just use valid commands.
          # The validation script needs the model registry cache populated or to query directly.
          # Let's use the CLI `describe-version` which handles registry init.
          
          python -m chat_pipeline.tracking.rollback_model \
            --model-name "$MODEL_NAME" \
            --registry-dir "gs://frontshiftai-model-registry" \
            --describe-version "$TARGET_VERSION" \
            --metadata-output "target_metadata.json"

          python3 <<'EOF' "target_metadata.json" "$GITHUB_OUTPUT"

      - name: Require Manual Approval for Production
        if: github.ref == 'refs/heads/main'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ github.repository_owner }}
          minimum-approvals: 1
          issue-title: "Rollback Approval Required"
          issue-body: |
            A rollback to version ${{ steps.resolve_version.outputs.target_version }} has been requested.
            
            **Reason:** ${{ inputs.reason }}
            
            **Target Metrics:**
            - Groundedness: ${{ steps.metadata.outputs.groundedness }}
            - Answer Relevance: ${{ steps.metadata.outputs.answer_relevance }}
            - Factual Correctness: ${{ steps.metadata.outputs.factual_correctness }}
            
            Please review and approve this rollback.

  execute-rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: validate-rollback-target
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set Environment Variables
        run: |
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
        shell: bash

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK (gsutil)
        uses: google-github-actions/setup-gcloud@v2

      - name: Execute Rollback
        env:
          TARGET_VERSION: ${{ needs.validate-rollback-target.outputs.target_version }}
          MODEL_NAME: ${{ inputs.model_name }}
          REASON: ${{ inputs.reason }}
        run: |
          if [ -z "$TARGET_VERSION" ]; then
            echo "❌ Target version output missing from validation job."
            exit 1
          fi
          python -m chat_pipeline.tracking.rollback_model \
            --model-name "$MODEL_NAME" \
            --registry-dir "gs://frontshiftai-model-registry" \
            --target-version "$TARGET_VERSION" \
            --reason "$REASON"

      - name: Upload Rollback Logs
        uses: actions/upload-artifact@v4
        with:
          name: rollback-logs
          path: models_registry/rollback_logs/
          retention-days: 90
        continue-on-error: true

  validation:
    name: Post-rollback Validation
    runs-on: ubuntu-latest
    needs: execute-rollback
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set Environment Variables
        run: |
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
        shell: bash

      - name: Download Rollback Logs
        uses: actions/download-artifact@v4
        with:
          name: rollback-logs
          path: models_registry/rollback_logs/
        continue-on-error: true

      - name: Verify Rolled-back Model
        run: |
          python3 << 'EOF'
          import json
          from pathlib import Path
          
          registry_dir = Path("models_registry")
          latest_path = registry_dir / "latest"
          
          if latest_path.exists():
              if latest_path.is_symlink():
                  version_dir = latest_path.resolve()
              else:
                  with open(latest_path, 'r') as f:
                      version_dir = Path(f.read().strip())
              
                  metadata_path = version_dir / "metadata.json"
                  if metadata_path.exists():
                      with open(metadata_path, 'r') as f:
                          metadata = json.load(f)
                  print(f"✅ Rollback verified:")
                  print(f"   Active version: {metadata.get('version')}")
                  print(f"   Model: {metadata.get('model_name')}")
                  print(f"   Evaluation: {metadata.get('evaluation', {})}")
              else:
                  print("⚠️ Metadata not found")
          else:
              print("⚠️ Latest symlink not found")
          EOF

      - name: Run Smoke Tests
        run: |
          echo "⚠️ Smoke tests skipped (requires full environment)"
          # In a real scenario, run smoke tests against rolled-back model
        continue-on-error: true

  notification-and-incident-log:
    name: Notification & Incident Log
    runs-on: ubuntu-latest
    needs: [validate-rollback-target, execute-rollback, validation]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Send Rollback Notification
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        run: |
          python3 << 'EOF'
          import os
          import smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          
          sender = os.getenv('EMAIL_SENDER')
          password = os.getenv('EMAIL_PASSWORD')
          receiver = os.getenv('EMAIL_RECEIVER')
          
          if not all([sender, password, receiver]):
              print('Email credentials not configured. Skipping notification.')
              exit(0)
          
          subject = f"FrontShiftAI Model Rollback Executed"
          body = f"""Model Rollback Executed
          
          Target Version: ${{ needs.validate-rollback-target.outputs.target_version }}
          Reason: ${{ inputs.reason }}
          Executed By: ${{ github.actor }}
          Timestamp: ${{ github.event.head_commit.timestamp }}
          
          View rollback details:
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          This is an automated message from FrontShiftAI CI/CD Pipeline.
          """
          
          msg = MIMEMultipart()
          msg['From'] = sender
          msg['To'] = receiver
          msg['Subject'] = subject
          msg.attach(MIMEText(body, 'plain'))
          
          try:
              with smtplib.SMTP_SSL('smtp.gmail.com', 465, timeout=15) as server:
                  server.login(sender, password)
                  server.send_message(msg)
              print(f'✅ Rollback notification sent to {receiver}')
          except Exception as e:
              print(f'❌ Failed to send notification: {e}')
          EOF

      - name: Create GitHub Issue for Tracking
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Rollback] Model rolled back to ${{ needs.validate-rollback-target.outputs.target_version }}`,
              body: `## Model Rollback Executed
              
              **Target Version:** ${{ needs.validate-rollback-target.outputs.target_version }}
              **Reason:** ${{ inputs.reason }}
              **Executed By:** ${{ github.actor }}
              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              
              This issue was automatically created to track the rollback incident.
              
              Please investigate the root cause and update this issue with findings.
              `,
              labels: ['rollback', 'incident']
            })
